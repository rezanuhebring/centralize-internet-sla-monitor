<# .SYNOPSIS Basic setup for Windows PowerShell SLA Agent. #>
param()
Write-Host "Starting Windows SLA Monitor Agent Setup..." -ForegroundColor Yellow
$AgentSourcePath = Split-Path -Parent $MyInvocation.MyCommand.Path; $AgentInstallDir = "C:\SLA_Monitor_Agent"; $MonitorScriptName = "Monitor-InternetAgent.ps1"; $ConfigTemplateName = "agent_config.ps1"
if (-not (Test-Path $AgentInstallDir)) { Write-Host "Creating directory: $AgentInstallDir"; New-Item -Path $AgentInstallDir -ItemType Directory -Force | Out-Null } else { Write-Host "Directory $AgentInstallDir already exists."}
Write-Host "Copying agent scripts..."; try { Copy-Item -Path (Join-Path $AgentSourcePath $MonitorScriptName) -Destination (Join-Path $AgentInstallDir $MonitorScriptName) -Force -ErrorAction Stop; Write-Host "- Copied $MonitorScriptName"; $DestinationConfigPath = Join-Path $AgentInstallDir $ConfigTemplateName; if (-not (Test-Path $DestinationConfigPath)) { Copy-Item -Path (Join-Path $AgentSourcePath $ConfigTemplateName) -Destination $DestinationConfigPath -Force -ErrorAction Stop; Write-Host "- Copied $ConfigTemplateName as initial configuration."; Write-Host "IMPORTANT: Please edit $DestinationConfigPath with this agent's unique details." -ForegroundColor Magenta } else { Write-Host "- Config file $DestinationConfigPath already exists. Review manually." -ForegroundColor Yellow} } catch { Write-Error "Failed to copy agent files: $($_.Exception.Message)"; exit 1 }
$TaskName = "InternetSLAMonitorAgent"; $TaskAction = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -File `"$AgentInstallDir\$MonitorScriptName`""; $TaskTrigger = New-ScheduledTaskTrigger -RepetitionInterval (New-TimeSpan -Minutes 15) -Once -At (Get-Date); $TaskPrincipal = New-ScheduledTaskPrincipal -UserID "NT AUTHORITY\SYSTEM" -LogonType ServiceAccount -RunLevel Highest; $TaskSettings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit (New-TimeSpan -Hours 1) -MultipleInstances IgnoreNew
Write-Host "Registering scheduled task '$TaskName'..."; try { Get-ScheduledTask -TaskName $TaskName -ErrorAction SilentlyContinue | Unregister-ScheduledTask -Confirm:$false; Register-ScheduledTask -TaskName $TaskName -Action $TaskAction -Trigger $TaskTrigger -Principal $TaskPrincipal -Settings $TaskSettings -ErrorAction Stop; Write-Host "Scheduled task '$TaskName' created/updated." } catch { Write-Error "Failed to register task '$TaskName': $($_.Exception.Message)"; Write-Warning "Create task manually."}
Write-Host "`nWindows SLA Monitor Agent Setup Complete." -ForegroundColor Green; Write-Host "--------------------------------------------------------------------"; Write-Host "NEXT STEPS:"; Write-Host "1. Edit: $AgentInstallDir\$ConfigTemplateName (Set AGENT_IDENTIFIER, AGENT_TYPE, CENTRAL_API_URL)"; Write-Host "2. Manually install Ookla's speedtest.exe, ensure it's in PATH or update '$MonitorScriptName'."; Write-Host "   Run 'speedtest.exe --accept-license --accept-gdpr' once."; Write-Host "3. Implement speedtest call & parsing in '$MonitorScriptName'."; Write-Host "4. Test: & `"$AgentInstallDir\$MonitorScriptName`""; Write-Host "5. Check log: $AgentInstallDir\internet_monitor_agent_windows.log"; Write-Host "--------------------------------------------------------------------"