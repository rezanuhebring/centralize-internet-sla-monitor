<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Performance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .dashboard-container { max-width: 1300px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #1a237e; text-align: center; }
        h1 { font-size: 2em; margin-bottom: 10px; } h2 { font-size: 1.6em; margin-top: 30px; margin-bottom: 20px;}
        .top-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; flex-wrap: wrap; gap: 15px; }
        .isp-selector-container label { margin-right: 8px; font-weight: 500; }
        .isp-selector-container select { padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; min-width: 300px; background-color: #fff; cursor: pointer;}
        .timestamp { font-size: 0.9em; color: #555; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .metric-card { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .metric-card h3 { margin-top: 0; color: #3f51b5; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; font-size: 1.2em; }
        .metric-card p { margin: 10px 0; font-size: 1em; line-height: 1.5; display: flex; justify-content: space-between; }
        .metric-card strong { font-weight: 600; }
        .chart-container { width: 100%; height: 320px; margin-top: 20px; }
        .sla-period-item, .summary-sla-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #e0e0e0; }
        .sla-period-item:last-child, .summary-sla-item:last-child { border-bottom: none; }
        .sla-period-label, .summary-sla-label { font-weight: 500; }
        .sla-percentage, .summary-sla-value { font-weight: bold; font-size: 1.2em; }
        .sla-percentage.met, .summary-sla-value.met { color: #28a745; }
        .sla-percentage.not-met, .summary-sla-value.not-met { color: #dc3545; }
        .sla-details { font-size: 0.9em; color: #6c757d; }
        .agent-list { list-style-type: none; padding: 0; }
        .agent-list-item { background-color: #fff; padding: 10px 15px; border-radius: 5px; border: 1px solid #dee2e6; margin-bottom: 8px; cursor: pointer; transition: box-shadow 0.2s; }
        .agent-list-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .agent-name { font-weight: bold; color: #007bff; }
        .hidden { display: none !important; }
        .loader { border: 5px solid #e0e0e0; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Internet Performance Monitor</h1>
        <div class="top-info">
            <div class="isp-selector-container">
                <label for="isp-profile-selector">View Dashboard:</label>
                <select id="isp-profile-selector"><option value="">Loading...</option></select>
            </div>
            <div id="last-checked" class="timestamp">Last Agent Check: Loading...</div>
        </div>
        <div id="loader" class="loader"></div>
        
        <!-- NEW: Overall Summary View -->
        <div id="overall-summary-section" class="hidden">
            <h2>System-Wide Health Summary</h2>
            <div class="grid-container">
                <div class="metric-card">
                    <h3>Overall SLA</h3>
                    <div id="overall-sla-periods"></div>
                </div>
                <div class="metric-card">
                    <h3>ISP Agents SLA (Last 30 Days)</h3>
                    <div class="summary-sla-item">
                        <span class="summary-sla-label">Average Uptime:</span>
                        <span id="avg-sla-isp" class="summary-sla-value">N/A</span>
                    </div>
                </div>
                <div class="metric-card">
                    <h3>Client Agents SLA (Last 30 Days)</h3>
                    <div class="summary-sla-item">
                        <span class="summary-sla-label">Average Uptime:</span>
                        <span id="avg-sla-client" class="summary-sla-value">N/A</span>
                    </div>
                </div>
            </div>
            <div class="grid-container" style="margin-top: 20px;">
                <div class="metric-card"><h3>Active ISP Agents</h3><ul id="isp-agent-list" class="agent-list"></ul></div>
                <div class="metric-card"><h3>Active Client Agents</h3><ul id="client-agent-list" class="agent-list"></ul></div>
            </div>
        </div>

        <!-- Individual Agent Detail View -->
        <div id="individual-agent-detail-section" class="hidden">
            <h2 id="agent-name-header"></h2>
            <div class="grid-container">
                <div class="metric-card"><h3><span role="img" aria-label="signal">ðŸ“¶</span> Ping & Connectivity</h3><p><span>Overall Status:</span> <strong id="ping-status">N/A</strong></p><p><span>Average RTT:</span> <strong id="ping-rtt">N/A</strong></p><p><span>Average Loss:</span> <strong id="ping-loss">N/A</strong></p><p><span>Average Jitter:</span> <strong id="ping-jitter">N/A</strong></p></div>
                <div class="metric-card"><h3><span role="img" aria-label="gauge">ðŸ’¨</span> Speed Test</h3><p><span>Status:</span> <strong id="speed-status">N/A</strong></p><p><span>Download:</span> <strong id="speed-dl">N/A</strong></p><p><span>Upload:</span> <strong id="speed-ul">N/A</strong></p><p><span>Ping (Speedtest):</span> <strong id="speed-ping">N/A</strong></p></div>
                <div class="metric-card"><h3><span role="img" aria-label="target">ðŸŽ¯</span> Service Level Agreement</h3><div id="historical-sla-data"></div></div>
            </div>
            <div class="grid-container" style="margin-top: 20px;">
                <div class="metric-card"><h3>RTT, Jitter (ms) & Loss (%)</h3><div class="chart-container"><canvas id="rttChart"></canvas></div></div>
                <div class="metric-card"><h3>Download & Upload Speed (Mbps)</h3><div class="chart-container"><canvas id="speedTestChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'get_sla_stats.php';
        let rttChartInstance = null;
        let speedChartInstance = null;
        let refreshIntervalTimer = null;

        const loader = document.getElementById('loader');
        const profileSelector = document.getElementById('isp-profile-selector');
        const summaryView = document.getElementById('overall-summary-section');
        const detailView = document.getElementById('individual-agent-detail-section');

        async function fetchAndUpdateDashboard(agentId = null) {
            loader.style.display = 'block';
            summaryView.classList.add('hidden');
            detailView.classList.add('hidden');
            
            let url = `${API_URL}?_=${new Date().getTime()}`;
            if (agentId) url += `&isp_id=${agentId}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.message || 'API returned an error.');

                updateProfileSelector(data.isp_profiles, agentId);
                
                if (agentId) {
                    renderDetailView(data);
                } else {
                    renderSummaryView(data);
                }

                if (refreshIntervalTimer) clearInterval(refreshIntervalTimer);
                refreshIntervalTimer = setInterval(() => fetchAndUpdateDashboard(profileSelector.value || null), data.dashboard_refresh_interval_ms || 60000);
            } catch (error) {
                console.error("Failed to fetch or render dashboard data:", error);
                document.body.innerHTML = `<div style="text-align:center;padding:50px;"><h1>Error</h1><p>Could not load dashboard data.</p><pre>${error.message}</pre></div>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        function updateProfileSelector(profiles, selectedId) {
            if (profileSelector.getAttribute('data-populated')) {
                profileSelector.value = selectedId || "";
                return;
            }
            profileSelector.innerHTML = '<option value="">-- Overall System Summary --</option>';
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.agent_name} (${profile.agent_type})`;
                profileSelector.appendChild(option);
            });
            profileSelector.value = selectedId || "";
            profileSelector.setAttribute('data-populated', 'true');
        }

        function setText(id, value, unit = '') {
            const el = document.getElementById(id);
            if (!el) return;
            const displayValue = (value !== null && value !== undefined && String(value).trim() !== '') ? String(value) : 'N/A';
            el.textContent = `${displayValue}${displayValue !== 'N/A' && unit ? `${unit}` : ''}`;
        }

        function renderSummaryView(data) {
            document.title = "Overall SLA Monitor";
            setText('last-checked', `Target SLA: ${data.target_sla_percentage}%`);

            const overallSlaContainer = document.getElementById('overall-sla-periods');
            overallSlaContainer.innerHTML = '';
            for (const key in data.periods) {
                const period = data.periods[key];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-sla-item';
                itemDiv.innerHTML = `<span class="summary-sla-label">${period.label}:</span> <span class="summary-sla-value ${period.achieved_percentage >= data.target_sla_percentage ? 'met' : 'not-met'}">${period.achieved_percentage}%</span>`;
                overallSlaContainer.appendChild(itemDiv);
            }

            const avgSlaIsp = document.getElementById('avg-sla-isp');
            const avgSlaClient = document.getElementById('avg-sla-client');
            avgSlaIsp.textContent = data.average_slas.isp !== null ? `${data.average_slas.isp}%` : 'N/A';
            avgSlaClient.textContent = data.average_slas.client !== null ? `${data.average_slas.client}%` : 'N/A';
            avgSlaIsp.className = `summary-sla-value ${data.average_slas.isp >= data.target_sla_percentage ? 'met' : 'not-met'}`;
            avgSlaClient.className = `summary-sla-value ${data.average_slas.client >= data.target_sla_percentage ? 'met' : 'not-met'}`;
            
            const ispList = document.getElementById('isp-agent-list');
            const clientList = document.getElementById('client-agent-list');
            ispList.innerHTML = ''; clientList.innerHTML = '';
            let hasIsps = false, hasClients = false;
            data.isp_profiles.forEach(profile => {
                const li = document.createElement('li');
                li.className = 'agent-list-item';
                li.innerHTML = `<span class="agent-name">${profile.agent_name}</span> <small>(${profile.agent_identifier})</small>`;
                li.onclick = () => { history.pushState({agent_id: profile.id}, '', `?isp_id=${profile.id}`); fetchAndUpdateDashboard(profile.id); };
                if (profile.agent_type === 'ISP') { ispList.appendChild(li); hasIsps = true; } 
                else { clientList.appendChild(li); hasClients = true; }
            });
            if (!hasIsps) ispList.innerHTML = '<li>No active ISP agents.</li>';
            if (!hasClients) clientList.innerHTML = '<li>No active Client agents.</li>';

            summaryView.classList.remove('hidden');
        }
        
        function renderDetailView(data) {
            document.title = `${data.current_isp_name} - SLA Monitor`;
            document.getElementById('agent-name-header').textContent = `${data.current_isp_name} Details`;
            const latest = data.latest_check;
            setText('last-checked', latest ? `Last Agent Check: ${new Date(latest.timestamp).toLocaleString()}` : 'No recent data for this agent.');
            
            setText('ping-status', latest?.overall_connectivity, '');
            setText('ping-rtt', latest?.avg_rtt_ms, 'ms');
            setText('ping-loss', latest?.avg_loss_percent, '%');
            setText('ping-jitter', latest?.avg_jitter_ms, 'ms');
            setText('speed-status', latest?.speedtest_status, '');
            setText('speed-dl', latest?.speedtest_download_mbps, 'Mbps');
            setText('speed-ul', latest?.speedtest_upload_mbps, 'Mbps');
            setText('speed-ping', latest?.speedtest_ping_ms, 'ms');

            const slaContainer = document.getElementById('historical-sla-data');
            slaContainer.innerHTML = `<h3>SLA (Target: ${data.target_sla_percentage}%)</h3>`;
            if (data.periods && Object.keys(data.periods).length > 0) {
                for (const key in data.periods) {
                    const period = data.periods[key];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'sla-period-item';
                    itemDiv.innerHTML = `<span class="sla-period-label">${period.label}:</span><span class="sla-percentage ${period.is_target_met ? 'met' : 'not-met'}">${period.achieved_percentage}%</span><span class="sla-details">(${period.met_intervals} of ${period.total_intervals} intervals)</span>`;
                    slaContainer.appendChild(itemDiv);
                }
            } else { slaContainer.innerHTML += '<p>No historical data available.</p>'; }
            
            renderRttChart(data.rtt_chart_data);
            renderSpeedTestChart(data.speed_chart_data);
            detailView.classList.remove('hidden');
        }
        
        function renderRttChart(data) {
            const ctx = document.getElementById('rttChart').getContext('2d');
            if (rttChartInstance) rttChartInstance.destroy();
            rttChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.timestamp)),
                    datasets: [
                        { label: 'Avg RTT (ms)', data: data.map(d => d.avg_rtt_ms), borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.2)', yAxisID: 'y', tension: 0.4, fill: true },
                        { label: 'Avg Jitter (ms)', data: data.map(d => d.avg_jitter_ms), borderColor: 'rgb(255, 159, 64)', backgroundColor: 'rgba(255, 159, 64, 0.2)', yAxisID: 'y', tension: 0.4, fill: true },
                        { label: 'Packet Loss (%)', data: data.map(d => d.avg_loss_percent), borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', type: 'bar', yAxisID: 'y1' }
                    ]
                },
                options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { type: 'time', time: { unit: 'hour', tooltipFormat: 'PPpp' } }, y: { beginAtZero: true, position: 'left', title: { display: true, text: 'ms' } }, y1: { type: 'linear', display: true, position: 'right', beginAtZero: true, max: 100, title: { display: true, text: '% Loss' }, grid: { drawOnChartArea: false } } } }
            });
        }
        
        function renderSpeedTestChart(data) {
            const ctx = document.getElementById('speedTestChart').getContext('2d');
            if (speedChartInstance) speedChartInstance.destroy();
            speedChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.timestamp)),
                    datasets: [
                        { label: 'Download (Mbps)', data: data.map(d => d.speedtest_download_mbps), borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.4, fill: true },
                        { label: 'Upload (Mbps)', data: data.map(d => d.speedtest_upload_mbps), borderColor: 'rgb(153, 102, 255)', backgroundColor: 'rgba(153, 102, 255, 0.2)', tension: 0.4, fill: true }
                    ]
                },
                options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { type: 'time', time: { unit: 'hour', tooltipFormat: 'PPpp' } }, y: { beginAtZero: true, title: { display: true, text: 'Mbps' } } } }
            });
        }
        
        profileSelector.addEventListener('change', (event) => {
            const selectedId = event.target.value;
            history.pushState({ agent_id: selectedId }, '', selectedId ? `?isp_id=${selectedId}` : window.location.pathname);
            fetchAndUpdateDashboard(selectedId || null);
        });

        window.addEventListener('popstate', (event) => {
            const agentId = event.state ? event.state.agent_id : new URLSearchParams(window.location.search).get('isp_id');
            fetchAndUpdateDashboard(agentId);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const initialAgentId = new URLSearchParams(window.location.search).get('isp_id');
            fetchAndUpdateDashboard(initialAgentId);
        });
    </script>
</body>
</html>