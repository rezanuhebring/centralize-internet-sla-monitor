<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Performance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333; --header-color: #1a237e; --border-color: #e0e0e0; --link-color: #007bff; --shadow-color: rgba(0,0,0,0.1); --green: #28a745; --red: #dc3545; --grey: #6c757d;}
        .dark-mode { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --header-color: #bb86fc; --border-color: #444; --link-color: #bb86fc; --shadow-color: rgba(0,0,0,0.4); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; background-color: var(--card-bg); padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); transition: background-color 0.3s; }
        h1, h2 { color: var(--header-color); text-align: center; }
        h1 { font-size: 2em; } h2 { font-size: 1.5em; margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .top-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 15px; }
        .isp-selector-container label { margin-right: 8px; font-weight: 500; }
        .isp-selector-container select { padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 1em; min-width: 300px; background-color: var(--card-bg); color: var(--text-color); }
        .timestamp { font-size: 0.9em; }
        .theme-switcher { display: flex; align-items: center; cursor: pointer; } .theme-switcher-label { margin-right: 8px; font-weight: 500;}
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; } .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #6200ea; } input:checked + .slider:before { transform: translateX(20px); }
        .download-button-container { text-align: center; margin-bottom: 20px; } 
        .download-button { display: inline-block; padding: 10px 20px; font-size: 1em; font-weight: bold; color: #fff; background-color: var(--link-color); border: none; border-radius: 5px; text-decoration: none; cursor: pointer; transition: background-color 0.2s; } 
        .download-button:hover { background-color: #0056b3; }
        .dark-mode .download-button:hover { background-color: #985eff; }
        .agent-lists-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; }
        .agent-list { list-style-type: none; padding: 0; }
        .agent-list li { background-color: var(--bg-color); margin-bottom: 10px; padding: 15px; border-radius: 6px; border-left: 5px solid var(--grey); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .agent-list li.status-up { border-left-color: var(--green); } .agent-list li.status-down { border-left-color: var(--red); }
        .agent-list li:hover { transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow-color); }
        .agent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .agent-name { font-weight: bold; font-size: 1.1em; color: var(--link-color); text-decoration: none; }
        .status-dot { height: 12px; width: 12px; background-color: var(--grey); border-radius: 50%; display: inline-block; }
        .status-dot.up { background-color: var(--green); } .status-dot.down { background-color: var(--red); }
        .agent-metrics { font-size: 0.9em; display: flex; justify-content: space-between; flex-wrap: wrap; }
        .agent-metrics span { margin-right: 15px; opacity: 0.9; }
        .hidden { display: none !important; }
        .loader { border: 5px solid #444; border-top: 5px solid #bb86fc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .metric-card { background-color: var(--bg-color); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .metric-card h3 { margin-top: 0; color: var(--header-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 1.2em; }
        .metric-card p { margin: 10px 0; font-size: 1em; line-height: 1.5; display: flex; justify-content: space-between; } .metric-card strong { font-weight: 600; }
        .sla-period-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border-color); }
        .sla-period-item:last-child { border-bottom: none; }
        .sla-period-label { font-weight: 500; } .sla-percentage { font-weight: bold; font-size: 1.2em; }
        .sla-percentage.met { color: var(--green); } .sla-percentage.not-met { color: var(--red); }
        .sla-details { font-size: 0.9em; opacity: 0.7; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="top-bar"><h1>Internet Performance Monitor</h1><div class="theme-switcher"><span class="theme-switcher-label">Dark Mode</span><label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></div></div>
        <div class="top-info"><div class="isp-selector-container"><label for="isp-profile-selector">View Dashboard:</label><select id="isp-profile-selector"><option value="">-- Show All Agents Summary --</option></select></div><div id="last-checked" class="timestamp">Last Update: Loading...</div></div>
        <div id="loader" class="loader"></div>
        <div id="dashboard-content" class="hidden">
            <div id="summary-view" class="hidden"><h2>System-Wide Health Summary</h2><div class="grid-container"><div class="metric-card"><h3>System-Wide SLA (Target: <span id="summary-sla-target">99.5</span>%)</h3><div id="overall-sla-periods"></div></div><div class="metric-card"><h3>System-Wide Average Ping/Loss</h3><div class="chart-container"><canvas id="cumulativeRttChart"></canvas></div></div><div class="metric-card"><h3>System-Wide Average Speedtest</h3><div class="chart-container"><canvas id="cumulativeSpeedChart"></canvas></div></div></div><div class="agent-lists-container" style="margin-top: 20px;"><div class="metric-card"><h3>Active ISP Agents</h3><ul id="isp-agent-list" class="agent-list"></ul></div><div class="metric-card"><h3>Active Client Agents</h3><ul id="client-agent-list" class="agent-list"></ul></div></div></div>
            <div id="detail-view" class="hidden"><h2 id="agent-name-header"></h2><div class="download-button-container"><a id="individual-csv-download" href="#" class="download-button"><span role="img" aria-label="floppy disk">ðŸ’¾</span> Download Agent Data (CSV)</a></div><div class="grid-container"><div class="metric-card"><h3><span role="img" aria-label="signal">ðŸ“¶</span> Ping & Connectivity</h3><p><span>Overall Status:</span> <strong id="ping-status">N/A</strong></p><p><span>Average RTT:</span> <strong id="ping-rtt">N/A</strong></p><p><span>Average Loss:</span> <strong id="ping-loss">N/A</strong></p><p><span>Average Jitter:</span> <strong id="ping-jitter">N/A</strong></p></div><div class="metric-card"><h3><span role="img" aria-label="gauge">ðŸ’¨</span> Speed Test</h3><p><span>Status:</span> <strong id="speed-status">N/A</strong></p><p><span>Download:</span> <strong id="speed-dl">N/A</strong></p><p><span>Upload:</span> <strong id="speed-ul">N/A</strong></p><p><span>Ping (Speedtest):</span> <strong id="speed-ping">N/A</strong></p></div><div class="metric-card"><h3><span role="img" aria-label="target">ðŸŽ¯</span> Service Level Agreement</h3><div id="historical-sla-data"></div></div></div><div class="grid-container" style="margin-top: 20px;"><div class="metric-card"><h3>Recent RTT, Jitter (ms) & Loss (%)</h3><div class="chart-container"><canvas id="rttChart"></canvas></div></div><div class="metric-card"><h3>Recent Download & Upload Speed (Mbps)</h3><div class="chart-container"><canvas id="speedTestChart"></canvas></div></div></div></div>
        </div>
    </div>
    <script>
        const API_URL = 'get_sla_stats.php';
        let rttChartInstance, speedChartInstance, cumulativeRttChartInstance, cumulativeSpeedChartInstance, refreshIntervalTimer;

        const loader = document.getElementById('loader');
        const profileSelector = document.getElementById('isp-profile-selector');
        const dashboardContent = document.getElementById('dashboard-content');
        const summaryView = document.getElementById('summary-view');
        const detailView = document.getElementById('detail-view');
        const themeToggle = document.getElementById('theme-toggle');

        function setText(id, value, unit = '') { const el = document.getElementById(id); if (el) el.textContent = (value !== null && value !== undefined && String(value).trim() !== '') ? `${String(value)}${unit}` : 'N/A'; }
        
        async function fetchAndUpdateDashboard(agentId = null) {
            loader.style.display = 'block';
            dashboardContent.classList.add('hidden');
            let url = `${API_URL}?_=${new Date().getTime()}`;
            if (agentId) url += `&isp_id=${agentId}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.message || 'API returned an error.');
                
                if(!profileSelector.getAttribute('data-populated')) {
                    updateProfileSelector(data.isp_profiles, agentId);
                }

                setText('last-checked', `Last Update: ${new Date().toLocaleString()}`);

                if (agentId) {
                    renderDetailView(data);
                } else {
                    renderSummaryView(data);
                }

                if (refreshIntervalTimer) clearInterval(refreshIntervalTimer);
                refreshIntervalTimer = setInterval(() => fetchAndUpdateDashboard(profileSelector.value || null), data.dashboard_refresh_interval_ms || 60000);

            } catch (error) {
                console.error("Failed to render dashboard data:", error);
                const errorMessage = `Could not load dashboard data. ${error.message}.`;
                dashboardContent.innerHTML = `<h2 style="color:var(--red)">Error</h2><p>${errorMessage}</p><p>Please check the browser console or server logs for more details.</p>`;
            } finally {
                loader.style.display = 'none';
                dashboardContent.classList.remove('hidden');
            }
        }

        function updateProfileSelector(profiles, selectedId) {
            profileSelector.innerHTML = '<option value="">-- Show All Agents Summary --</option>';
            (profiles || []).forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.agent_name} (${profile.agent_identifier}) ${profile.is_active ? '' : '(Inactive)'}`;
                profileSelector.appendChild(option);
            });
            profileSelector.value = selectedId || "";
            profileSelector.setAttribute('data-populated', 'true');
        }

        function renderSummaryView(data) {
            document.title = "Overall SLA Monitor";
            setText('summary-sla-target', data.target_sla_percentage);
            const overallSlaContainer = document.getElementById('overall-sla-periods');
            overallSlaContainer.innerHTML = '';
            (Object.values(data.periods) || []).forEach(period => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'sla-period-item';
                const metClass = period.is_target_met ? 'met' : 'not-met';
                itemDiv.innerHTML = `<span class="sla-period-label">${period.label}:</span> <span class="sla-percentage ${metClass}">${period.achieved_percentage}%</span>`;
                overallSlaContainer.appendChild(itemDiv);
            });
            
            const ispList = document.getElementById('isp-agent-list');
            const clientList = document.getElementById('client-agent-list');
            ispList.innerHTML = ''; clientList.innerHTML = '';
            
            (data.isp_profiles || []).forEach(profile => {
                if (!profile.is_active) return;
                const status = data.all_agent_status[profile.id];
                const statusClass = status ? (status.overall_connectivity?.toLowerCase() || 'unknown') : 'unknown';
                const rtt = status ? (status.avg_rtt_ms !== null ? `${status.avg_rtt_ms}ms` : 'N/A') : 'N/A';
                const loss = status ? (status.avg_loss_percent !== null ? `${status.avg_loss_percent}%` : 'N/A') : 'N/A';
                const lastCheck = status ? new Date(status.timestamp).toLocaleTimeString() : 'Never';

                const li = document.createElement('li');
                li.className = `status-${statusClass}`;
                li.dataset.id = profile.id;
                li.innerHTML = `<div class="agent-header"><span class="agent-name">${profile.agent_name}</span><span class="status-dot ${statusClass}"></span></div><div class="agent-metrics"><span>RTT: <strong>${rtt}</strong></span><span>Loss: <strong>${loss}</strong></span><span style="font-size:0.8em; opacity:0.7;">Last Check: ${lastCheck}</span></div>`;
                
                if (profile.agent_type === 'ISP') { ispList.appendChild(li); } 
                else { clientList.appendChild(li); }
            });

            if(ispList.children.length === 0) ispList.innerHTML = '<li>No active ISP agents found.</li>';
            if(clientList.children.length === 0) clientList.innerHTML = '<li>No active Client agents found.</li>';
            
            renderChart('cumulativeRttChart', { 'Avg RTT (ms)': 'avg_rtt', 'Avg Loss (%)': 'avg_loss', 'Avg Jitter (ms)': 'avg_jitter' }, data.cumulative_ping_chart_data, 'day');
            renderChart('cumulativeSpeedChart', { 'Avg Download (Mbps)': 'avg_dl', 'Avg Upload (Mbps)': 'avg_ul' }, data.cumulative_speed_chart_data, 'day');

            summaryView.classList.remove('hidden');
            detailView.classList.add('hidden');
        }

        function renderDetailView(data) {
            setText('agent-name-header', data.current_isp_name);
            const latest = data.latest_check;
            
            setText('ping-status', latest?.overall_connectivity); setText('ping-rtt', latest?.avg_rtt_ms, ' ms'); setText('ping-loss', latest?.avg_loss_percent, ' %'); setText('ping-jitter', latest?.avg_jitter_ms, ' ms');
            setText('speed-status', latest?.speedtest_status); setText('speed-dl', latest?.speedtest_download_mbps, ' Mbps'); setText('speed-ul', latest?.speedtest_upload_mbps, ' Mbps'); setText('speed-ping', latest?.speedtest_ping_ms, ' ms');

            const slaContainer = document.getElementById('historical-sla-data');
            slaContainer.innerHTML = `<h3>SLA (Target: ${data.target_sla_percentage}%)</h3>`;
            if (data.periods && Object.keys(data.periods).length > 0) {
                for (const key in data.periods) {
                    const period = data.periods[key];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'sla-period-item';
                    itemDiv.innerHTML = `<span class="sla-period-label">${period.label}:</span><span class="sla-percentage ${period.is_target_met ? 'met' : 'not-met'}">${period.achieved_percentage}%</span><span class="sla-details">(${period.met_intervals} of ${period.total_intervals} met)</span>`;
                    slaContainer.appendChild(itemDiv);
                }
            } else { slaContainer.innerHTML += '<p>No historical data available.</p>'; }
            
            const downloadLink = document.getElementById('individual-csv-download');
            if (downloadLink) {
                downloadLink.href = `generate_csv.php?isp_id=${data.current_isp_profile_id}`;
                const safeFilename = data.current_isp_name.replace(/[^a-zA-Z0-9_]/g, '_');
                downloadLink.setAttribute('download', `sla_history_${safeFilename}.csv`);
            }
            
            renderChart('rttChart', { 'Avg RTT (ms)': 'avg_rtt_ms', 'Avg Jitter (ms)': 'avg_jitter_ms', 'Packet Loss (%)': 'avg_loss_percent' }, data.rtt_chart_data, 'timestamp');
            renderChart('speedTestChart', { 'Download (Mbps)': 'speedtest_download_mbps', 'Upload (Mbps)': 'speedtest_upload_mbps' }, data.speed_chart_data, 'timestamp');
            
            summaryView.classList.add('hidden');
            detailView.classList.remove('hidden');
        }
        
        // *** FIX: New, robust chart rendering function ***
        function renderChart(canvasId, seriesConfig, data, xKey) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;

            let chartInstance;
            switch(canvasId) {
                case 'rttChart': chartInstance = rttChartInstance; break;
                case 'speedTestChart': chartInstance = speedChartInstance; break;
                case 'cumulativeRttChart': chartInstance = cumulativeRttChartInstance; break;
                case 'cumulativeSpeedChart': chartInstance = cumulativeSpeedChartInstance; break;
            }

            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDark ? '#e0e0e0' : '#333';
            const colors = ['54, 162, 235', '255, 159, 64', '255, 99, 132', '75, 192, 192', '153, 102, 255'];
            
            const datasets = Object.entries(seriesConfig).map(([label, key], index) => ({
                label: label,
                data: data.map(d => d[key]),
                borderColor: `rgb(${colors[index % colors.length]})`,
                backgroundColor: `rgba(${colors[index % colors.length]}, 0.2)`,
                type: label.includes('%') ? 'bar' : 'line',
                tension: 0.3,
                fill: true,
                yAxisID: label.includes('%') ? 'y1' : (label.includes('Jitter') ? 'y2' : 'y')
            }));

            const chartOptions = { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { type: xKey === 'timestamp' ? 'time' : 'category', time: { unit: 'hour', tooltipFormat: 'PPpp' }, grid: { color: gridColor }, ticks: { color: fontColor } }, y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: fontColor }, title: { display: true, text: 'ms', color: fontColor} } }, plugins: { legend: { labels: { color: fontColor } } } };
            
            if (canvasId === 'rttChart' || canvasId === 'cumulativeRttChart') {
                chartOptions.scales.y1 = { type: 'linear', display: true, position: 'right', beginAtZero: true, max: 100, title: { display: true, text: '% Loss', color: fontColor }, grid: { drawOnChartArea: false }, ticks: { color: fontColor } };
                chartOptions.scales.y2 = { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Jitter (ms)', color: fontColor }, grid: { drawOnChartArea: false }, ticks: { color: fontColor } };
            }
             if (canvasId === 'speedTestChart' || canvasId === 'cumulativeSpeedChart') {
                chartOptions.scales.y.title.text = 'Mbps';
            }
            
            const newChart = new Chart(ctx, { type: 'line', data: { labels: data.map(d => d[xKey]), datasets: datasets }, options: chartOptions });
            
            switch(canvasId) {
                case 'rttChart': rttChartInstance = newChart; break;
                case 'speedTestChart': speedChartInstance = newChart; break;
                case 'cumulativeRttChart': cumulativeRttChartInstance = newChart; break;
                case 'cumulativeSpeedChart': cumulativeSpeedChartInstance = newChart; break;
            }
        }
        
        function applyTheme(isDark) { document.body.classList.toggle('dark-mode', isDark); fetchAndUpdateDashboard(profileSelector.value || null); }
        document.addEventListener('click', (e) => { if (e.target.closest('.agent-list-item')) { const agentId = e.target.closest('.agent-list-item').dataset.id; profileSelector.value = agentId; history.pushState({ agent_id: agentId }, '', `?isp_id=${agentId}`); fetchAndUpdateDashboard(agentId); }});
        profileSelector.addEventListener('change', (e) => { const agentId = e.target.value; const url = agentId ? `?isp_id=${agentId}` : './'; history.pushState({ agent_id: agentId }, '', url); fetchAndUpdateDashboard(agentId || null); });
        themeToggle.addEventListener('change', () => { localStorage.setItem('dark-mode', themeToggle.checked); applyTheme(themeToggle.checked); });
        window.addEventListener('popstate', (event) => { const agentId = event.state ? event.state.agent_id : new URLSearchParams(window.location.search).get('isp_id'); fetchAndUpdateDashboard(agentId); });
        
        document.addEventListener('DOMContentLoaded', () => {
            const isDarkMode = localStorage.getItem('dark-mode') === 'true';
            document.body.classList.toggle('dark-mode', isDarkMode);
            themeToggle.checked = isDarkMode;
            const initialAgentId = new URLSearchParams(window.location.search).get('isp_id');
            fetchAndUpdateDashboard(initialAgentId);
        });
    </script>
</body>
</html>